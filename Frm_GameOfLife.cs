/*
 
⠀⠀⠀⠀⠀⠀⠀⢠⣿⣿⣦⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣿⣦⡀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢠⣿⣿⣿⣿⣆⠀⠀⠀⠀⠀⠀⠀⠀⣾⣿⣿⣿⣷⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⢀⣾⣿⣿⣿⣿⣿⡆⠀⠀⠀⠀⠀⠀⣸⣿⣿⣿⣿⣿⡆⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⣾⣿⣿⣿⣿⣿⣿⣿⡀⠀⠀⠀⠀⢀⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣧⠀⠀⠀⠀⣼⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣠⣤⣤⣼⣿⣿⣿⣿⣿⣿⣿⣿⣷⠀⠀⠀⠀⠀
⠀⠀⠀⢀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⠀⠀
⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⠀⠀
⠀⠀⠀⠘⣿⣿⣿⣿⠟⠁⠀⠀⠀⠹⣿⣿⣿⣿⣿⠟⠁⠀⠀⠹⣿⣿⡿⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣿⣿⣿⡇⠀⠀⠀⢼⣿⠀⢿⣿⣿⣿⣿⠀⣾⣷⠀⠀⢿⣿⣷⠀⠀⠀⠀⠀
⠀⠀⠀⢠⣿⣿⣿⣷⡀⠀⠀⠈⠋⢀⣿⣿⣿⣿⣿⡀⠙⠋⠀⢀⣾⣿⣿⠀⠀⠀⠀⠀
⢀⣀⣀⣀⣿⣿⣿⣿⣿⣶⣶⣶⣶⣿⣿⣿⣿⣾⣿⣷⣦⣤⣴⣿⣿⣿⣿⣤⠤⢤⣤⡄
⠈⠉⠉⢉⣙⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣇⣀⣀⣀⡀⠀
⠐⠚⠋⠉⢀⣬⡿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⣥⣀⡀⠈⠀⠈⠛
⠀⠀⠴⠚⠉⠀⠀⠀⠉⠛⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠛⠋⠁⠀⠀⠀⠉⠛⠢⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀

Federico Zuffa
16.01.2026
Classe Passerelle
Projet Game of Life V1.3

*/
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;


namespace Projet_GameOfLife
{
    // Form principal : initialisation UI, connexion entre les controls (pictureBox, timer, menus)
    // et la logique de la grille.
    public partial class Frm_GameOfLife : Form
    {
        private const int WINDOW_WIDTH = 1152;
        private const int WINDOW_HEIGHT = 648;

        private Grid _grid;
        private int _lastRow = -1;
        private int _lastCol = -1;
        private bool _isMouseDown = false;
        private int _speedInterval;
        private int _nbSteps = 1;
        private bool[,] initialState;
        private Panel _viewportPanel;
        private string _usedRule = "ClassicRule";


        internal Grid Grid { get => _grid; set => _grid = value; }
        public int LastRow { get => _lastRow; set => _lastRow = value; }
        public int LastCol { get => _lastCol; set => _lastCol = value; }
        public bool IsMouseDown { get => _isMouseDown; set => _isMouseDown = value; }
        public int SpeedInterval { get => _speedInterval; set => _speedInterval = value; }
        public int NbSteps { get => _nbSteps; set => _nbSteps = value; }
        public string UsedRule { get => _usedRule; set => _usedRule = value; }

        public Frm_GameOfLife()
        {
            InitializeComponent();
            //this.ClientSize = new Size(WINDOW_WIDTH, WINDOW_HEIGHT);
        }


        // Chargement du formulaire :
        // - crée la grille,
        // - configure timer/trackbar,
        // - prépare le viewport (panel) et le zoom initial,
        // - initialise le bitmap de la grille et l'affiche.
        private void Frm_GameOfLife_Load(object sender, EventArgs e)
        {
            Grid = new Grid(144, 256); //100 row, 100 col

            // Timer et Trackbar           
            trckBr_Speed.Minimum = 1;
            trckBr_Speed.Maximum = 100;
            trckBr_Speed.Value = 2;
            ApplySpeedFromTrckbr();

            // Affichage
            SetupGeneral();
            SetupViewportPanel();
            ApplyZoom(newCellSize: 8);

            // Gestion molette (zoom)
            _viewportPanel.MouseWheel += ViewportPanel_MouseWheel;
            _viewportPanel.MouseEnter += (_, __) => _viewportPanel.Focus();
            _viewportPanel.TabStop = true;

            Grid.CellSize = Math.Min((int)(pictureBox1.Width / Grid.NbColumn), (int)(pictureBox1.Height / Grid.NbRow));
            Grid.InitializeBitMap(pictureBox1.Width, pictureBox1.Height);

            Grid.Display();
            pictureBox1.Image = Grid.Bitmap;
        }

        private void SetupGeneral()
        {
            this.ClientSize = new Size(WINDOW_WIDTH + 20, WINDOW_HEIGHT + 100);
            panel1.Size = new Size(WINDOW_WIDTH, WINDOW_HEIGHT);
            pictureBox1.Location = new Point(10, 50);
        }

        // Crée un panel AutoScroll et y place le pictureBox afin de supporter pan/scroll.
        private void SetupViewportPanel()
        {
            if (_viewportPanel != null) return;

            _viewportPanel = new Panel
            {
                AutoScroll = true,
                BorderStyle = BorderStyle.FixedSingle
            };

            _viewportPanel.Location = pictureBox1.Location;
            _viewportPanel.Size = pictureBox1.Size;
            _viewportPanel.Anchor = pictureBox1.Anchor;

            this.Controls.Remove(pictureBox1);
            pictureBox1.Location = new Point(0, 0);
            pictureBox1.SizeMode = PictureBoxSizeMode.Normal;
            pictureBox1.BackColor = Color.Black;
            _viewportPanel.Controls.Add(pictureBox1);

            // Ajoute le panel au Form
            this.Controls.Add(_viewportPanel);
            _viewportPanel.BringToFront();
        }

        // Applique le zoom en changeant la taille des cellules et en réinitialisant le bitmap.
        private void ApplyZoom(int newCellSize)
        {
            newCellSize = Math.Max(2, Math.Min(10, newCellSize));

            Grid.CellSize = newCellSize;

            int pixelWidth = Grid.NbColumn * Grid.CellSize + 1;
            int pixelHeight = Grid.NbRow * Grid.CellSize + 1;

            pictureBox1.Size = new Size(pixelWidth, pixelHeight);

            Grid.InitializeBitMap(pixelWidth, pixelHeight);
            Grid.Display();

            pictureBox1.Image = Grid.Bitmap;
            pictureBox1.Refresh();
        }

        private void ViewportPanel_MouseWheel(object sender, MouseEventArgs e)
        {
            int delta = e.Delta;
            if (delta > 0)
            {
                delta = 1;
            }
            else
            {
                delta = -1;
            }
            ApplyZoom(Grid.CellSize + delta);
        }

        // Avance d'une étape (bouton Step). Sauvegarde de l'état initial la première fois.
        private void btn_Step_Click(object sender, EventArgs e)
        {
            if (NbSteps == 1)
            {
                initialState = Grid.CopyCurrentState();
            }
            Grid.Step(UsedRule);
            Grid.Display();
            NbSteps++;
            lbl_nbStep.Text = "STEPS : " + NbSteps.ToString();
            pictureBox1.Refresh();
        }

        private void btn_RESET_Click(object sender, EventArgs e)
        {
            NbSteps = 0;
            Grid.ClearDisplay();
            pictureBox1.Refresh();
        }

        // --- Interaction souris : dessiner / effacer cellules via pictureBox ---
        private void pictureBox1_MouseDown(object sender, MouseEventArgs e)
        {
            IsMouseDown = true;
            MouseDraw(e);
        }

        private void pictureBox1_MouseMove(object sender, MouseEventArgs e)
        {
            if (IsMouseDown)
            {
                MouseDraw(e);
            }
        }
        private void pictureBox1_MouseUp(object sender, MouseEventArgs e)
        {
            IsMouseDown = false;
            LastRow = -1;
            LastCol = -1;
        }

        // Détecte la cellule sous le curseur et met à jour uniquement si la cellule change
        // (évite d'écrire continuellement la même cellule).
        private void MouseDraw(MouseEventArgs e)
        {
            if (Grid.IsCellInGrid(e.X, e.Y))
            {
                int[] cells = Grid.GetCellFromPixel(e.X, e.Y);
                int currentRow = cells[0];
                int currentCol = cells[1];
                if (currentRow != LastRow || currentCol != LastCol)
                {
                    if (e.Button == MouseButtons.Left)
                    {
                        Grid.SetCellState(currentRow, currentCol, true);
                    }
                    if (e.Button == MouseButtons.Right)
                    {
                        Grid.SetCellState(currentRow, currentCol, false);
                    }
                    LastRow = currentRow;
                    LastCol = currentCol;

                    Grid.Display();
                    pictureBox1.Refresh();
                }
            }
        }

        // Démarre / stoppe le timer de simulation. Sauvegarde l'état initial avant démarrage.
        private void btn_START_Click(object sender, EventArgs e)
        {
            if (btn_START.Text == "START")
            {
                initialState = Grid.CopyCurrentState();
                timer1.Start();
                btn_START.Text = "STOP";
            }
            else
            {
                timer1.Stop();
                btn_START.Text = "START";
            }
        }

        // Tick du timer : avance la simulation et met à jour l'affichage.
        private void timer1_Tick(object sender, EventArgs e)
        {
            Grid.Step(UsedRule);
            Grid.Display();
            pictureBox1.Refresh();
            NbSteps++;
            lbl_nbStep.Text = "STEPS : " + NbSteps.ToString();

            // Contrôle du taux de rafraichissement
            ApplySpeedFromTrckbr();
        }

        private void ApplySpeedFromTrckbr()
        {
            int genPerSec = trckBr_Speed.Value;
            int timerTick = Math.Max(1, 1000 / genPerSec);
            timer1.Interval = timerTick;
        }

        private void btn_BackToInitialConfig_Click(object sender, EventArgs e)
        {
            NbSteps = 0;
            Grid.PasteInitialState(initialState);
            Grid.Display();
            pictureBox1.Refresh();
        }

        // Menus : affichage, quitter, crédits, choix des règles et motifs prédéfinis.
        private void afficherGrilleToolStripMenuItem_CheckedChanged(object sender, EventArgs e)
        {
            Grid.ShowGrid = afficherGrilleToolStripMenuItem.Checked;
            Grid.Display();
            pictureBox1.Refresh();
        }

        private void fernerToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.Close();
        }

        private void creditsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            MessageBox.Show("Conway's Game of Life \n Version 1.3 \n \n Développé par : Federico Zuffa \n Année : 2026", "Crédits", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        // Règles
        private void highLifeRulesToolStripMenuItem_CheckedChanged(object sender, EventArgs e)
        {
            if (highLifeRulesToolStripMenuItem.Checked)
            {
                règlesOriginalesToolStripMenuItem.Checked = false;
                UsedRule = "HighLifeRule";
            }
        }

        private void règlesOriginalesToolStripMenuItem_CheckedChanged(object sender, EventArgs e)
        {
            if (règlesOriginalesToolStripMenuItem.Checked)
            {
                highLifeRulesToolStripMenuItem.Checked = false;
                UsedRule = "ClassicRule";
            }
        }

        private void règlesOriginalesToolStripMenuItem_Click(object sender, EventArgs e)
        {
            règlesOriginalesToolStripMenuItem.Checked = true;
            highLifeRulesToolStripMenuItem.Checked = !règlesOriginalesToolStripMenuItem.Checked;
            UsedRule = "ClassicRule";
        }

        private void highLifeRulesToolStripMenuItem_Click(object sender, EventArgs e)
        {
            highLifeRulesToolStripMenuItem.Checked = true;
            règlesOriginalesToolStripMenuItem.Checked = !highLifeRulesToolStripMenuItem.Checked;
            UsedRule = "HighLifeRule";
        }

        // Motifs prédéfinis : efface la grille, place le motif via les méthodes Grid.Glider/Exploder/etc.
        private void gliderToolStripMenuItem_Click(object sender, EventArgs e)
        {
            gliderToolStripMenuItem.Checked = true;
            Grid.ClearDisplay();
            Grid.Glider();
            Grid.Display();
            pictureBox1.Refresh();
        }

        private void exploderToolStripMenuItem_Click(object sender, EventArgs e)
        {
            exploderToolStripMenuItem.Checked = true;
            Grid.ClearDisplay();
            Grid.Exploder();
            Grid.Display();
            pictureBox1.Refresh();
        }

        private void smallExploderToolStripMenuItem_Click(object sender, EventArgs e)
        {
            smallExploderToolStripMenuItem.Checked = true;
            Grid.ClearDisplay();
            Grid.SmallExploder();
            Grid.Display();
            pictureBox1.Refresh();
        }

        private void soupToolStripMenuItem_Click(object sender, EventArgs e)
        {
            soupToolStripMenuItem.Checked = true;
            Grid.ClearDisplay();
            Grid.Soup();
            Grid.Display();
            pictureBox1.Refresh();
        }

        private void factoryToolStripMenuItem_Click(object sender, EventArgs e)
        {
            factoryToolStripMenuItem.Checked = true;
            Grid.ClearDisplay();
            Grid.Factory();
            Grid.Display();
            pictureBox1.Refresh();
        }

        private void replicatorhighLifeToolStripMenuItem_Click(object sender, EventArgs e)
        {
            replicatorhighLifeToolStripMenuItem.Checked = true;
            Grid.ClearDisplay();
            Grid.Replicator();
            Grid.Display();
            pictureBox1.Refresh();
        }
    }
}
