/*
 
⠀⠀⠀⠀⠀⠀⠀⢠⣿⣿⣦⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣿⣦⡀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢠⣿⣿⣿⣿⣆⠀⠀⠀⠀⠀⠀⠀⠀⣾⣿⣿⣿⣷⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⢀⣾⣿⣿⣿⣿⣿⡆⠀⠀⠀⠀⠀⠀⣸⣿⣿⣿⣿⣿⡆⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⣾⣿⣿⣿⣿⣿⣿⣿⡀⠀⠀⠀⠀⢀⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣧⠀⠀⠀⠀⣼⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣠⣤⣤⣼⣿⣿⣿⣿⣿⣿⣿⣿⣷⠀⠀⠀⠀⠀
⠀⠀⠀⢀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⠀⠀
⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⠀⠀
⠀⠀⠀⠘⣿⣿⣿⣿⠟⠁⠀⠀⠀⠹⣿⣿⣿⣿⣿⠟⠁⠀⠀⠹⣿⣿⡿⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣿⣿⣿⡇⠀⠀⠀⢼⣿⠀⢿⣿⣿⣿⣿⠀⣾⣷⠀⠀⢿⣿⣷⠀⠀⠀⠀⠀
⠀⠀⠀⢠⣿⣿⣿⣷⡀⠀⠀⠈⠋⢀⣿⣿⣿⣿⣿⡀⠙⠋⠀⢀⣾⣿⣿⠀⠀⠀⠀⠀
⢀⣀⣀⣀⣿⣿⣿⣿⣿⣶⣶⣶⣶⣿⣿⣿⣿⣾⣿⣷⣦⣤⣴⣿⣿⣿⣿⣤⠤⢤⣤⡄
⠈⠉⠉⢉⣙⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣇⣀⣀⣀⡀⠀
⠐⠚⠋⠉⢀⣬⡿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⣥⣀⡀⠈⠀⠈⠛
⠀⠀⠴⠚⠉⠀⠀⠀⠉⠛⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠛⠋⠁⠀⠀⠀⠉⠛⠢⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀

Federico Zuffa
16.01.2026
Classe Passerelle
Projet Game of Life V1

*/
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;


namespace Projet_GameOfLife
{
    public partial class Frm_GameOfLife : Form
    {
        private const int WINDOW_WIDTH = 1152;
        private const int WINDOW_HEIGHT = 648;

        private Grid _grid;
        private int _lastRow = -1;
        private int _lastCol = -1;
        private bool _isMouseDown = false;
        private int _speedInterval;
        private readonly Rules rules = new Rules();
        private int _nbSteps = 1;
        private bool[,] initialState;
        private Panel _viewportPanel;

        internal Grid Grid { get => _grid; set => _grid = value; }
        public int LastRow { get => _lastRow; set => _lastRow = value; }
        public int LastCol { get => _lastCol; set => _lastCol = value; }
        public bool IsMouseDown { get => _isMouseDown; set => _isMouseDown = value; }
        public int SpeedInterval { get => _speedInterval; set => _speedInterval = value; }
        public int NbSteps { get => _nbSteps; set => _nbSteps = value; }

        public Frm_GameOfLife()
        {
            InitializeComponent();
            //this.ClientSize = new Size(WINDOW_WIDTH, WINDOW_HEIGHT);
        }


        private void Frm_GameOfLife_Load(object sender, EventArgs e)
        {
            Grid = new Grid(200, 200); //100 row, 100 col

            //Timer et Trackbar           

            trckBr_Speed.Minimum = 1;
            trckBr_Speed.Maximum = 100;
            trckBr_Speed.Value = 2;
            ApplySpeedFromTrckbr();

            //Affichage

            SetupViewportPanel();
            ApplyZoom(newCellSize: 8);
            // 5) Events souris
            pictureBox1.MouseDown += pictureBox1_MouseDown;
            pictureBox1.MouseMove += pictureBox1_MouseMove;
            pictureBox1.MouseUp += pictureBox1_MouseUp;

            // Zoom molette (molette marche mieux sur un control focusable, d’où Focus())
            _viewportPanel.MouseWheel += ViewportPanel_MouseWheel;
            _viewportPanel.MouseEnter += (_, __) => _viewportPanel.Focus();
            _viewportPanel.TabStop = true;

            Grid.CellSize = Math.Min((int)(pictureBox1.Width / Grid.NbColumn), (int)(pictureBox1.Height / Grid.NbRow));

            Grid.InitializeBitMap(pictureBox1.Width, pictureBox1.Height);

            //TEST Planneur

            //Grid.SetCellState(1, 2, true);
            //Grid.SetCellState(2, 3, true);
            //Grid.SetCellState(3, 1, true);
            //Grid.SetCellState(3, 2, true);
            //Grid.SetCellState(3, 3, true);

            // TEST HELICE

            //Grid.SetCellState(1, 4, true);
            //Grid.SetCellState(1, 5, true);
            //Grid.SetCellState(1, 6, true);
            //Grid.SetCellState(1, 5, true);
            //Grid.SetCellState(2, 3, true);
            //Grid.SetCellState(2, 5, true);
            //Grid.SetCellState(3, 1, true);
            //Grid.SetCellState(3, 2, true);
            //Grid.SetCellState(3, 3, true);
            //Grid.SetCellState(3, 4, true);
            //Grid.SetCellState(3, 5, true);
            //Grid.SetCellState(4, 1, true);
            //Grid.SetCellState(4, 3, true);
            //Grid.SetCellState(5, 1, true);
            //Grid.SetCellState(5, 3, true);
            //Grid.SetCellState(5, 4, true);
            //Grid.SetCellState(5, 5, true);





            Grid.Display();
            pictureBox1.Image = Grid.Bitmap;
        }

        // ========= VIEWPORT (scroll/pan) =========
        private void SetupViewportPanel()
        {
            // Si déjà créé, on ne refait pas
            if (_viewportPanel != null) return;

            // On crée un Panel AutoScroll et on y place pictureBox1
            _viewportPanel = new Panel
            {
                AutoScroll = true,
                BorderStyle = BorderStyle.FixedSingle
            };

            // On place le panel là où était pictureBox1
            _viewportPanel.Location = pictureBox1.Location;
            _viewportPanel.Size = pictureBox1.Size;
            _viewportPanel.Anchor = pictureBox1.Anchor;

            // Retire pictureBox1 du Form et l’ajoute dans le panel
            this.Controls.Remove(pictureBox1);
            pictureBox1.Location = new Point(0, 0);
            pictureBox1.SizeMode = PictureBoxSizeMode.Normal;
            pictureBox1.BackColor = Color.Black;
            _viewportPanel.Controls.Add(pictureBox1);

            // Ajoute le panel au Form
            this.Controls.Add(_viewportPanel);
            _viewportPanel.BringToFront();
        }

        // ========= ZOOM =========
        private void ApplyZoom(int newCellSize)
        {
            // Clamp pour éviter un zoom absurde
            newCellSize = Math.Max(2, Math.Min(10, newCellSize));

            Grid.CellSize = newCellSize;

            int pixelWidth = Grid.NbColumn * Grid.CellSize + 1;
            int pixelHeight = Grid.NbRow * Grid.CellSize + 1;

            pictureBox1.Size = new Size(pixelWidth, pixelHeight);

            Grid.InitializeBitMap(pixelWidth, pixelHeight);
            Grid.Display();

            pictureBox1.Image = Grid.Bitmap;
            pictureBox1.Refresh();
        }
        private void ViewportPanel_MouseWheel(object sender, MouseEventArgs e)
        {
            int delta = e.Delta;
            if (delta > 0)
            {
                delta = 1;
            }
            else {
                delta = -1;
            }
                ApplyZoom(Grid.CellSize + delta);
        }

        private void btn_Step_Click(object sender, EventArgs e)
        {
            if (NbSteps == 1) {
                initialState = Grid.CopyCurrentState();
            }
            Grid.Step(rules);
            Grid.Display();
            NbSteps++;
            lbl_nbStep.Text = "STEPS : " + NbSteps.ToString();
            pictureBox1.Refresh();
        }
        private void btn_RESET_Click(object sender, EventArgs e)
        {
            Grid.ClearDisplay();
            pictureBox1.Refresh();
            NbSteps = 0;
        }

        private void pictureBox1_MouseDown(object sender, MouseEventArgs e)
        {
            IsMouseDown = true;
            MouseDraw(e);
        }

        private void pictureBox1_MouseMove(object sender, MouseEventArgs e)
        {
            if (IsMouseDown)
            {
                MouseDraw(e);
            }
        }
        private void pictureBox1_MouseUp(object sender, MouseEventArgs e)
        {
            IsMouseDown = false;
            LastRow = -1;
            LastCol = -1;
        }


        private void MouseDraw(MouseEventArgs e)
        {
            if (Grid.IsCellInGrid(e.X, e.Y))
            {
                int[] cells = Grid.GetCellFromPixel(e.X, e.Y);
                int currentRow = cells[0];
                int currentCol = cells[1];
                if (currentRow != LastRow || currentCol != LastCol)
                {
                    if (e.Button == MouseButtons.Left)
                    {
                        Grid.SetCellState(currentRow, currentCol, true);
                    }
                    if (e.Button == MouseButtons.Right)
                    {
                        Grid.SetCellState(currentRow, currentCol, false);
                    }
                    LastRow = currentRow;
                    LastCol = currentCol;

                    Grid.Display();
                    pictureBox1.Refresh();
                }
            }
        }

        private void btn_START_Click(object sender, EventArgs e)
        {
            if (btn_START.Text == "START")
            {
                initialState = Grid.CopyCurrentState();
                timer1.Start();
                btn_START.Text = "STOP";
            }
            else
            {
                timer1.Stop();
                btn_START.Text = "START";
            }
        }

        private void timer1_Tick(object sender, EventArgs e)
        {
            Grid.Step(rules);
            Grid.Display();
            pictureBox1.Refresh();
            NbSteps++;
            lbl_nbStep.Text = "STEPS : " + NbSteps.ToString();

            //Contrôleur du taux de rafraichissement
            ApplySpeedFromTrckbr();
        }

        private void ApplySpeedFromTrckbr()
        {
            int genPerSec = trckBr_Speed.Value;
            //int timerTick = Math.Max(1,trckBr_Speed.Maximum - genPerSec); 
            int timerTick = Math.Max(1, 1000 / genPerSec);
            timer1.Interval = timerTick;
        }

        private void btn_BackToInitialConfig_Click(object sender, EventArgs e)
        {
            Grid.PasteInitialState(initialState);
            Grid.Display();
            pictureBox1.Refresh();
        }
    }
}
